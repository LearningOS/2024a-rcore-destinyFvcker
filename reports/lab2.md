# lab2

-   [lab2](#lab2)
    -   [SV39 页表项的组成及标志位作用](#sv39-页表项的组成及标志位作用)
    -   [缺页可能导致的异常](#缺页可能导致的异常)
    -   [缺页时相关寄存器的值](#缺页时相关寄存器的值)
    -   [Lazy 策略的好处](#lazy-策略的好处)
    -   [SV39 页表占用内存估算](#sv39-页表占用内存估算)
    -   [实现 Lazy 策略的思考](#实现-lazy-策略的思考)
    -   [页表项中的页面失效表现](#页表项中的页面失效表现)
    -   [单页表的页表更换及用户态控制](#单页表的页表更换及用户态控制)
    -   [单页表的优势](#单页表的优势)
    -   [双页表的页表切换时机](#双页表的页表切换时机)
    -   [荣誉准则](#荣誉准则)

## SV39 页表项的组成及标志位作用

SV39 页表项（PTE，Page Table Entry）是 RISC-V 架构中的一个页表项格式，用于实现虚拟地址到物理地址的映射。它的组成包括以下字段：

1. Valid 位（V）：如果该位为 1，表示该页表项有效。否则，表示该页表项无效。
2. Read 位（R）：如果该位为 1，表示该页面是可读的。
3. Write 位（W）：如果该位为 1，表示该页面是可写的。
4. Execute 位（X）：如果该位为 1，表示该页面是可执行的。
5. User 位（U）：如果该位为 1，表示该页面允许用户态访问。如果为 0，表示只有内核态可以访问。
6. Global 位（G）：如果该位为 1，表示该页面在所有地址空间中是共享的，不受地址空间标识符（ASID）影响。
7. Access 位（A）：如果该位为 1，表示该页面已经被访问过。
8. Dirty 位（D）：如果该位为 1，表示该页面被写过（即内容被修改过）。
9. 物理页面号（PPN）：指向物理页框的高位地址。

这些标志位控制了页面的权限、状态以及映射，操作系统依赖这些标志位进行内存管理和保护。

## 缺页可能导致的异常

缺页可能导致以下几种异常：

1. 页面不存在异常（Page Fault）：当进程访问的页面不在内存中时，会触发缺页异常。
2. 非法访问异常：如果页面的权限不足（如尝试写一个只读页面），也会触发异常。
3. 权限错误异常：例如用户态进程尝试访问内核态页面。
4. 地址未对齐异常：某些情况下，如果映射不正确或者访问地址不对齐，也会出现类似缺页的异常。

## 缺页时相关寄存器的值

1. satp（Supervisor Address Translation and Protection Register）：包含页表根地址和模式，发生缺页时该寄存器保持当前进程的页表根地址。
2. sepc（Supervisor Exception Program Counter）：保存导致缺页的指令地址，异常处理程序通过该寄存器找到出错指令并决定重新执行或终止进程。
3. stval（Supervisor Trap Value）：保存导致缺页的虚拟地址，操作系统根据这个地址进行页表填充。
4. scause（Supervisor Cause Register）：保存异常的具体原因，包括缺页类型（如加载页缺页、存储页缺页等）。

## Lazy 策略的好处

Lazy 策略（延迟加载）有以下优点：

1. 节省内存和计算资源：只有在需要时才分配页面，减少了不必要的内存占用和页表操作，避免为从未访问的页面做无意义的加载。
2. 加快启动速度：进程启动时无需立即加载所有页面，能更快开始执行。
3. 更高效的磁盘访问：通过减少不必要的页面加载，降低了磁盘 I/O 操作的频率。

## SV39 页表占用内存估算

对于 10GB 的连续内存页面，SV39 页表需要多级页表来映射。SV39 使用 4KB 页面，三级页表结构：

-   每级页表包含 512 项（因为 9 位用于索引，每项 8 字节）。
-   对于 10GB 内存空间，大约需要映射 2.5M 页（$10 \times 2^{30} / 2^{12}$）。

假设平均每级都使用部分页表项，估算页表占用大约为：

$$
3 \times \frac{10GB}{2MB} = 15MB
$$

## 实现 Lazy 策略的思考

实现 Lazy 策略的关键在于页面只有在第一次访问时才分配或加载。可以通过以下步骤实现：

1. 初始映射时标记为无效：在初始页表中标记所有页表项为无效，且在 PTE 中保留磁盘或其他持久化存储中页面的位置信息。
2. 缺页处理：当发生缺页异常时，操作系统捕捉异常，检查磁盘上的页面信息，并将页面从磁盘加载到内存中，更新页表项并标记为有效，重新执行指令。

## 页表项中的页面失效表现

当页面被交换到磁盘时，页表项中的 Valid 位（V） 会被清 0，表示该页面当前无效。此时操作系统还可以通过页表项中的其他信息（如物理页面号）记录页面在磁盘中的位置。

## 单页表的页表更换及用户态控制

在单页表的情况下，用户线程和内核线程共用同一张页表。为了控制用户态无法访问内核页面，内核页面的页表项中会将 User 位（U） 设置为 0，确保用户态无法访问这些页面。只有在内核态访问时，这些内核地址才会被合法访问。

更换页表时，操作系统会更新 satp 寄存器，该寄存器指向当前进程的页表根地址。

## 单页表的优势

单页表的优势包括：

1. 内存占用较少：用户态和内核态共享同一张页表，节省了内存中存放页表的空间。
2. 页表切换开销低：因为不需要在用户态和内核态之间频繁切换页表，减少了上下文切换时的开销。

## 双页表的页表切换时机

在双页表设计下，通常在 用户态切换到内核态时 需要更换页表。每当发生系统调用、中断或异常时，操作系统会切换到内核页表，并在返回用户态时切换回用户页表。

如果设计为单页表操作系统，页表的切换通常发生在 进程切换时，即每次上下文切换到不同的进程时，都需要更换页表。

## 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

    我没有和任何人进行交流

2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

    - rCore-Gamp-Guide-2024A 文档
    - rCore-Tutorial- Book-v3 3.6.0- alpha.1 文档

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。
